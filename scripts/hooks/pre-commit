#!/bin/bash
#
# Pre-commit hook - Validate repository structure
#
# This hook ensures files are in the correct locations:
# - User docs in plugins/autonomous-dev/docs/
# - Dev docs in docs/
# - No duplicates between root and plugin
# - Clean root directory
#
# To install this hook:
#   ln -sf ../../scripts/hooks/pre-commit .git/hooks/pre-commit
#
# To bypass (emergency only):
#   git commit --no-verify

set -e

echo "üîç Validating repository structure..."

# Run structure validation
python3 scripts/validate_structure.py

echo "üîç Checking for accidentally staged .claude/ files..."

# Block .claude/ files except PROJECT.md
STAGED_CLAUDE_FILES=$(git diff --cached --name-only | grep "^\.claude/" | grep -v "^\.claude/PROJECT.md" || true)
if [ -n "$STAGED_CLAUDE_FILES" ]; then
    echo ""
    echo "‚ùå ERROR: Attempting to commit .claude/ files (should be gitignored):"
    echo "$STAGED_CLAUDE_FILES"
    echo ""
    echo "These are generated/installed files. Only .claude/PROJECT.md should be tracked."
    echo ""
    echo "To fix:"
    echo "  git reset HEAD .claude/  # Unstage these files"
    echo "  git status --ignored     # Verify they're ignored"
    echo ""
    echo "To bypass (NOT recommended): git commit --no-verify"
    exit 1
fi

echo "üîç Validating slash command implementations..."

# Run command validation (archived hook, still useful for pre-commit)
if [ -f "plugins/autonomous-dev/hooks/archived/validate_commands.py" ]; then
    python3 plugins/autonomous-dev/hooks/archived/validate_commands.py
fi

echo "üîç Syncing install manifest with source files..."

# Auto-sync install_manifest.json (archived hook, still useful for pre-commit)
if [ -f "plugins/autonomous-dev/hooks/archived/validate_install_manifest.py" ]; then
    python3 plugins/autonomous-dev/hooks/archived/validate_install_manifest.py
    MANIFEST_EXIT=$?
    if [ $MANIFEST_EXIT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Manifest sync failed. Check output above."
        exit $MANIFEST_EXIT
    fi
fi

# If manifest was updated, stage it
if git diff --name-only | grep -q "install_manifest.json"; then
    echo "üì¶ Manifest updated - auto-staging..."
    git add plugins/autonomous-dev/config/install_manifest.json
fi

echo "üîç Validating settings template hooks exist..."

# Ensure hooks referenced in settings template actually exist
if [ -f "plugins/autonomous-dev/hooks/archived/validate_settings_hooks.py" ]; then
    python3 plugins/autonomous-dev/hooks/archived/validate_settings_hooks.py
    SETTINGS_EXIT=$?
    if [ $SETTINGS_EXIT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Settings template references missing hooks. Fix before committing."
        exit $SETTINGS_EXIT
    fi
fi

echo "üîç Validating library imports..."

# Ensure all lib imports resolve (catches deleted/renamed libs)
if [ -f "plugins/autonomous-dev/hooks/archived/validate_lib_imports.py" ]; then
    python3 plugins/autonomous-dev/hooks/archived/validate_lib_imports.py
    IMPORTS_EXIT=$?
    if [ $IMPORTS_EXIT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Broken library imports detected. Fix before committing."
        exit $IMPORTS_EXIT
    fi
fi

echo "üîç Validating all hooks documented..."

# Ensure all hooks have documentation in HOOKS.md
if [ -f "plugins/autonomous-dev/hooks/archived/validate_hooks_documented.py" ]; then
    python3 plugins/autonomous-dev/hooks/archived/validate_hooks_documented.py
    DOCS_EXIT=$?
    if [ $DOCS_EXIT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  New hooks need documentation. Add to docs/HOOKS.md before committing."
        exit $DOCS_EXIT
    fi
fi

echo "üîç Running documentation validation tests..."

# Check if venv exists and has pytest
if [ -f "venv/bin/pytest" ]; then
    venv/bin/pytest tests/integration/test_documentation_references.py -q --tb=line 2>/dev/null || true
    TEST_EXIT=$?
    if [ $TEST_EXIT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Documentation tests failed. Fix issues or bypass with: git commit --no-verify"
        exit $TEST_EXIT
    fi
elif command -v pytest &> /dev/null; then
    pytest tests/integration/test_documentation_references.py -q --tb=line 2>/dev/null || true
    TEST_EXIT=$?
    if [ $TEST_EXIT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Documentation tests failed. Fix issues or bypass with: git commit --no-verify"
        exit $TEST_EXIT
    fi
else
    echo "‚ö†Ô∏è  pytest not installed, skipping documentation tests"
    echo "   Install: python3 -m venv venv && source venv/bin/activate && pip install pytest pytest-cov"
fi

# If all validations pass, allow commit
exit 0

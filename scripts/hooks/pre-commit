#!/bin/bash
#
# Pre-commit hook - Validate repository structure
#
# This hook ensures files are in the correct locations:
# - User docs in plugins/autonomous-dev/docs/
# - Dev docs in docs/
# - No duplicates between root and plugin
# - Clean root directory
#
# To install this hook:
#   ln -sf ../../scripts/hooks/pre-commit .git/hooks/pre-commit
#
# To bypass (emergency only):
#   git commit --no-verify

set -e

echo "üîç Validating repository structure..."

# Run structure validation
python scripts/validate_structure.py

echo "üîç Validating slash command implementations..."

# Run command validation
python plugins/autonomous-dev/hooks/validate_commands.py

echo "üîç Running documentation validation tests..."

# Check if venv exists and has pytest
if [ -f "venv/bin/pytest" ]; then
    venv/bin/pytest tests/unit/test_claude_md_optimization.py tests/integration/test_documentation_references.py -q --tb=line
    TEST_EXIT=$?
    if [ $TEST_EXIT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Documentation tests failed. Fix issues or bypass with: git commit --no-verify"
        exit $TEST_EXIT
    fi
elif command -v pytest &> /dev/null; then
    pytest tests/unit/test_claude_md_optimization.py tests/integration/test_documentation_references.py -q --tb=line
    TEST_EXIT=$?
    if [ $TEST_EXIT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Documentation tests failed. Fix issues or bypass with: git commit --no-verify"
        exit $TEST_EXIT
    fi
else
    echo "‚ö†Ô∏è  pytest not installed, skipping documentation tests"
    echo "   Install: python -m venv venv && source venv/bin/activate && pip install pytest pytest-cov"
fi

# If all validations pass, allow commit
exit 0

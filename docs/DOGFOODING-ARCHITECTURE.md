# Dogfooding Architecture - Final Design

**Date**: 2025-10-21
**Decision**: Reverse flow - Edit plugin source, install to test
**Status**: Implemented

---

## Architecture Overview

### Single Source of Truth: `plugins/autonomous-dev/`

**This is the ONLY place you edit automations:**

```
plugins/autonomous-dev/          # ← EDIT & COMMIT HERE
├── commands/                    # ← Edit commands here
├── agents/                      # ← Edit agents here
├── skills/                      # ← Edit skills here
├── hooks/                       # ← Edit hooks here
├── templates/                   # ← Edit templates here
├── docs/                        # ← User documentation
├── scripts/setup.py             # ← User setup
└── tests/                       # ← Plugin feature tests
```

### Testing Location: `.claude/` (Gitignored)

**Generated by plugin install - DO NOT edit directly:**

```
.claude/                         # ← INSTALLED (gitignored)
├── commands/                    # ← Installed from plugin
├── agents/                      # ← Installed from plugin
├── skills/                      # ← Installed from plugin
├── hooks/                       # ← Installed from plugin
├── templates/                   # ← Installed from plugin
├── PROJECT.md                   # ← Local config (kept in git)
└── settings.local.json          # ← Local config (kept in git)
```

### Dev Documentation: `docs/` (Not Distributed)

**For contributors working ON the plugin:**

```
docs/                            # ← DEV DOCS (not distributed)
├── CONTRIBUTING.md              # ← How to contribute
├── DEVELOPMENT.md               # ← Development workflow
├── ARCHITECTURE.md              # ← System architecture
├── DOGFOODING-ARCHITECTURE.md   # ← This file
├── sessions/                    # ← Session logs
└── archive/                     # ← Old documentation
```

### Build Tools: `scripts/` (Not Distributed)

**Validation and build scripts:**

```
scripts/                         # ← BUILD TOOLS (not distributed)
├── validate_structure.py        # ← Structure validation
└── hooks/                       # ← Git hooks
```

### Infrastructure Tests: `tests/` (Not Distributed)

```
tests/                           # ← INFRASTRUCTURE TESTS (not distributed)
├── unit/                        # ← Unit tests for repo structure
└── integration/                 # ← Integration tests
```

---

## The Dogfooding Principle

**You test exactly what users get:**

1. Edit source in `plugins/autonomous-dev/`
2. Install plugin to `.claude/` (simulates user install)
3. Test commands/agents/skills from `.claude/`
4. If it works, commit `plugins/autonomous-dev/`

**Result**: If it works for you, it works for users!

---

## Daily Workflow

### 1. Edit Plugin Source

```bash
# Edit in the ONLY source location
vim plugins/autonomous-dev/commands/test.md
vim plugins/autonomous-dev/agents/planner.md
```

### 2. Install/Reinstall Plugin

```bash
# Reinstall to test changes
/plugin uninstall autonomous-dev
/plugin install autonomous-dev

# Or manually (faster during dev):
rm -rf .claude/commands .claude/agents .claude/skills .claude/hooks .claude/templates
cp -r plugins/autonomous-dev/commands .claude/
cp -r plugins/autonomous-dev/agents .claude/
cp -r plugins/autonomous-dev/skills .claude/
cp -r plugins/autonomous-dev/hooks .claude/
cp -r plugins/autonomous-dev/templates .claude/
```

### 3. Test

```bash
# Test the command (reads from installed .claude/)
/test

# Test the agent
# Agents automatically load from .claude/
```

### 4. Commit Plugin Source

```bash
# Stage changes (ONLY plugin source, not .claude/)
git add plugins/autonomous-dev/

# Commit
git commit -m "Update test command"

# .claude/ is gitignored - not committed
```

---

## What Gets Committed vs Gitignored

### Committed (Source Code)

✅ `plugins/autonomous-dev/` - Plugin source (all files)
✅ `docs/` - Dev documentation
✅ `scripts/` - Build/validation tools
✅ `tests/` - Infrastructure tests
✅ `.claude/PROJECT.md` - Local project config
✅ `.claude/settings.local.json` - Local settings
✅ Root files (README.md, CHANGELOG.md, etc.)

### Gitignored (Generated/Installed)

❌ `.claude/commands/` - Installed from plugin
❌ `.claude/agents/` - Installed from plugin
❌ `.claude/skills/` - Installed from plugin
❌ `.claude/hooks/` - Installed from plugin
❌ `.claude/templates/` - Installed from plugin

**See `.gitignore` for complete list**

---

## Two Types of Documentation

### 1. User Documentation (Distributed)

**Location**: `plugins/autonomous-dev/docs/`
**Audience**: Plugin users (marketplace customers)
**Managed**: Manually in plugin source

**Files**:
- QUICKSTART.md
- COMMANDS.md
- TROUBLESHOOTING.md
- TESTING_GUIDE.md
- etc.

### 2. Developer Documentation (Not Distributed)

**Location**: `docs/`
**Audience**: Contributors working ON the plugin
**Managed**: Manually in root

**Files**:
- CONTRIBUTING.md
- DEVELOPMENT.md
- ARCHITECTURE.md
- DOGFOODING-ARCHITECTURE.md
- sessions/

**These are SEPARATE sources** - not duplicates!

---

## Structure Validation

**Script**: `scripts/validate_structure.py`

**Checks**:
- ✅ Plugin source complete
- ✅ No duplicates between root and plugin
- ✅ User docs in `plugins/autonomous-dev/docs/`
- ✅ Dev docs in `docs/`
- ✅ Clean root directory

**Run**:
```bash
python scripts/validate_structure.py
```

---

## Benefits

### Dogfooding
✅ Test exactly what users get
✅ Catch issues before distribution
✅ No "works on my machine" problems

### Single Source
✅ Edit in ONE place (plugin source)
✅ No manual sync needed
✅ No duplication errors

### Clean Separation
✅ Plugin source vs installed plugin
✅ User docs vs dev docs
✅ Clear git history

---

## Migration from Old Architecture

### Before (Duplicated)
```
.claude/commands/           # Edited here
plugins/../commands/        # Manually synced (error-prone!)
```

### After (Dogfooding)
```
plugins/../commands/        # ONLY source (edit here)
.claude/commands/           # Installed (gitignored)
```

### Migration Steps

1. ✅ Add `.claude/` directories to `.gitignore`
2. ✅ Remove tracked `.claude/hooks/` from git
3. ✅ Update validation script
4. ✅ Document workflow in CONTRIBUTING.md
5. ⏳ Test plugin install/uninstall cycle

---

## FAQ

### Q: Where do I edit commands?
**A**: `plugins/autonomous-dev/commands/` (source)

### Q: Where does Claude Code read commands from?
**A**: `.claude/commands/` (installed plugin)

### Q: How do I test changes?
**A**: Install plugin (`/plugin install autonomous-dev`)

### Q: What do I commit?
**A**: Only `plugins/autonomous-dev/` (not `.claude/`)

### Q: What about `.claude/PROJECT.md`?
**A**: Keep in git (local project config, not plugin source)

### Q: What about dev documentation?
**A**: Goes in `docs/` (not distributed, not in plugin)

---

**This architecture ensures you test what you ship, with no duplication.**

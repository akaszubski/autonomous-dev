## [Unreleased]

### Added
- Strict PROJECT.md alignment gate with score-based validation (#251)
  - Created alignment_gate.py library for GenAI-powered feature alignment validation
  - Strict gatekeeper: Requires explicit SCOPE membership (not "related to")
  - Score-based gating (7+ threshold for approval, 0-10 scale)
  - Constraint violation detection (blocks even high-scoring features)
  - AlignmentGateResult dataclass with comprehensive validation data
  - validate_alignment_strict() for feature validation against PROJECT.md
  - check_scope_membership() for explicit SCOPE matching
  - track_alignment_decision() to logs/alignment_history.jsonl (JSONL format)
  - get_alignment_stats() for meta-validation statistics
  - Support for Anthropic and OpenRouter APIs
  - Dynamic project root detection with fallback handling
  - 54 unit tests for validation, scoring, tracking, and statistics
- Quality persistence enforcement for /implement --batch (#254)
  - Created quality_persistence_enforcer.py central enforcement engine
  - Completion gate enforcement (100% test pass requirement, no faking)
  - EnforcementResult dataclass with test failure and coverage tracking
  - RetryStrategy with escalation logic (3-attempt progression)
  - CompletionSummary with honest status (completed, failed, skipped counts)
  - MAX_RETRY_ATTEMPTS=3 with per-attempt strategy variation
  - COVERAGE_THRESHOLD=80% for quality metrics
  - Enforce 100% test pass rate (not 80%, not "most" - all tests must pass)
  - Track skipped/failed features separately from completed features
  - generate_honest_summary() for transparent batch completion reporting
  - should_close_issue() integration with quality gates
  - 35+ unit tests for gate enforcement, strategies, and summaries
- Quality gate integration in batch_issue_closer.py (#254)
  - Added is_feature_skipped_or_failed() to check quality gate status
  - Added add_blocked_label_to_issue() for failed features
  - Skipped/failed issues stay OPEN with 'blocked' label (not closed)
  - Only close issues for features that passed quality gates
  - Graceful degradation if GitHub API unavailable
  - 15+ unit tests for quality gate checks and label application
- Exponential backoff with jitter in batch_retry_manager.py (#254)
  - AWS-pattern exponential backoff: delay = BASE_RETRY_DELAY * (2 ^ attempt)
  - Added jitter to prevent thundering herd: random +/- 10% of base delay
  - BASE_RETRY_DELAY = 1.0 second, MAX_RETRY_DELAY = 60 seconds
  - Backoff delays per attempt: 1s, 2s, 4s (capped at 60s)
  - calculate_backoff_delay() for transparent delay calculation
  - 10+ unit tests for backoff delays and jitter
- Quality metrics tracking in batch_state_manager.py (#254)
  - Added skipped_features field to track intentionally skipped work
  - Added quality_metrics field for test pass rate and coverage tracking
  - Enhanced state schema: quality_metrics with test_pass_rate, coverage_percent
  - batch_state.json now captures full quality picture (not just pass/fail)
  - 8+ unit tests for metrics persistence
- Enforce /implement workflow with audit logging (#250)
  - Created workflow_violation_logger.py library for audit logging
  - JSON Lines format (one event per line) for easy parsing
  - Log rotation (10MB max size, keep 10 backups) to prevent disk exhaustion
  - Thread-safe logging for concurrent hook executions
  - CWE-117 prevention: Input sanitization prevents log injection attacks
  - ViolationType enum: DIRECT_IMPLEMENTATION, GIT_BYPASS_ATTEMPT, PROTECTED_PATH_EDIT
  - ViolationLogEntry dataclass with timestamp, type, file_path, agent_name, reason, details
  - parse_violation_log() function for querying violations with filters (type, agent, time range)
  - get_violation_summary() for statistics (total, by_type, by_agent, time range)
  - Default log location: logs/workflow_violations.log (configurable)
  - 30+ unit tests for logger, rotation, thread safety, injection prevention
- Protected paths enforcement for workflow discipline (#250)
  - Enhanced enforce_implementation_workflow.py with protected paths feature
  - Blocks edits to .claude/commands/*.md (command definitions)
  - Blocks edits to .claude/agents/*.md (agent definitions)
  - Blocks edits to plugins/autonomous-dev/lib/*.py (core library infrastructure)
  - Logs violations to workflow_violation_logger for audit trail
  - Allows ALLOWED_AGENTS (implementer, test-master, etc.) to edit protected paths
  - Can be controlled via ENFORCE_WORKFLOW_STRICT=true (opt-in)
  - Helpful error messages guide users to proper workflow
- Git bypass blocking PreCommit hook (block_git_bypass.py) (#250)
  - Prevents bypassing pre-commit hooks with git commit --no-verify
  - Detects --no-verify and --no-gpg-sign flags in git commit commands
  - Blocks bypass attempts with EXIT_BLOCK=2 and helpful message
  - Logs violations to workflow_violation_logger for audit trail
  - Can be disabled with ALLOW_GIT_BYPASS=true for emergency situations
  - Validates that hooks are actually configured before blocking
  - 20+ unit tests for flag detection, logging, exit codes, error messages
- Pre-merge check for worktree push status (#240)
  - Added check_worktree_push_status() function to verify branch is pushed
  - merge_worktree() now verifies branch is pushed before merge (check_push=True default)
  - force_merge parameter to bypass push check if needed
  - PushStatus dataclass with is_pushed, commits_ahead, remote_branch, error_message
  - 6 unit tests for push status functionality
- Auto-stash before worktree merge (#241)
  - merge_worktree() now auto-stashes uncommitted changes before merge (auto_stash=True default)
  - Detects file overlap between uncommitted changes and merge files
  - Returns error if overlap detected (prevents merge conflicts with local changes)
  - Automatically restores stash on merge failure or checkout errors
  - Pops stash after successful merge to restore uncommitted changes
  - 6 unit tests for auto-stash functionality
- Batch completion summary for visibility into merged vs pending work (#242)
  - Added BatchCompletionSummary dataclass with feature counts, issue tracking, git stats
  - Added generate_completion_summary() function to analyze batch state
  - Shows completed/failed/pending feature counts and descriptions
  - Categorizes issues by completion status (completed vs pending)
  - Compares commits in worktree vs main branch
  - Generates actionable next steps (resume, retry, merge, push)
  - Provides resume command when pending features exist
  - format_summary() method for readable console output
  - 8 unit tests for completion summary
- AUTO_INSTALL_DEPS environment variable for automatic dependency installation
  - Created auto_install_deps.py library with security-first design
  - Parses pytest output for ImportError/ModuleNotFoundError
  - Extracts package names from error messages
  - Validates packages against project requirements files (pyproject.toml, requirements.txt)
  - Only installs packages explicitly listed in project requirements (CWE-494 prevention)
  - Uses subprocess with shell=False (CWE-78 prevention, no command injection)
  - 30-second timeout for pip install (default, configurable)
  - Audit logging for all install attempts
  - Environment variable: AUTO_INSTALL_DEPS=true to enable (default: false)
  - Package name mapping for PyPI vs import names (e.g., pillow -> PIL)
  - Core functions: extract_missing_packages(), is_package_allowed(), install_package(), auto_install_missing_deps()
  - Security features: Whitelist validation, audit logging, timeout protection
- /audit command for comprehensive quality checks (#239)
  - Run code quality, documentation, coverage, and security audits
  - Support for --quick, --security, --docs, --code flags
  - Generates detailed report in docs/sessions/AUDIT_REPORT_<timestamp>.md
  - Catches issues before they accumulate (prevents 726 print statement scenarios)
- Test coverage threshold now configurable via environment variables (#238)
  - Enhanced auto_enforce_coverage.py with MIN_COVERAGE env var (default: 70%)
  - Added COVERAGE_REPORT env var for custom report path
  - 8 unit tests for environment variable configuration
- Pre-commit hook to enforce logging over print statements (#236)
  - Created enforce_logging_only.py with print statement detection
  - Scans lib/ and hooks/ directories for print statements
  - Excludes CLI tools (argparse, click, typer, main guard)
  - Excludes test files by default
  - Environment variable: ENFORCE_LOGGING_ONLY=true to enable (default: false)
  - Additional controls: ALLOW_PRINT_IN_CLI, ALLOW_PRINT_IN_TESTS
  - 25+ unit tests for comprehensive coverage
- Document doc-master command deprecation/rename handling workflow (#228)
  - 5-step workflow for comprehensive deprecation handling
  - Step 1: Find ALL references (grep entire codebase)
  - Step 2: Categorize by location (docs vs historical vs hooks)
  - Step 3: Bulk update non-historical references
  - Step 4: Update validation hooks
  - Step 5: Verify zero remaining stale references
  - Prevents 80%+ of missed references during command consolidation
- Create plugins/autonomous-dev/README.md with comprehensive user documentation (#233)
  - User-focused installation and quick-start guide (5 minutes)
  - All 8 core commands with examples and use cases
  - Configuration guide (environment variables, git automation, MCP auto-approval)
  - 22-agent architecture overview with model tier strategy
  - 66-hook automation reference with examples
  - Troubleshooting guide with common issues and solutions
  - Best practices section (context management, workflow discipline, PROJECT.md-first)
  - Documentation index linking to all detailed guides
  - Cross-references to contributor and security documentation
- Unified `/implement` command with mode flags (#203)
  - Default mode: Full 8-agent pipeline (replaces `/auto-implement`)
  - `--quick`: Implementer agent only (replaces old `/implement`)
  - `--batch <file>`: Batch from file with auto-worktree isolation
  - `--issues <nums>`: Batch from GitHub issues with auto-worktree isolation
  - `--resume <id>`: Resume interrupted batch
  - Auto-worktree creation for batch modes (isolated development)
  - Created `batch_orchestrator.py` library for flag parsing and mode routing
  - 32 unit tests + 14 integration tests
- Per-worktree batch state isolation for concurrent development (#226)
  - Enhanced get_batch_state_file() to detect git worktrees
  - Worktrees now use isolated batch state: WORKTREE_DIR/.claude/batch_state.json
  - Main repository continues using: REPO_ROOT/.claude/batch_state.json (backward compatible)
  - Graceful fallback to main repo behavior on detection errors
  - Security: CWE-22 (path traversal), CWE-59 (symlink) protection maintained
  - Added is_worktree() lazy-loaded wrapper in path_utils.py
  - Performance: Worktree detection <1ms, zero overhead for state isolation
  - 15 unit tests + 9 integration tests with real git worktrees
  - Enables concurrent batch processing in multiple worktrees without interference
- StateManager Abstract Base Class for state management (#220)
  - Created abstract_state_manager.py with StateManager ABC
  - Abstract methods: load_state(), save_state(), cleanup_state()
  - Concrete helpers: exists(), _validate_state_path(), _atomic_write(), _get_file_lock(), _audit_operation()
  - Security features: CWE-22 path traversal, CWE-59 symlink, CWE-367 atomic writes, CWE-732 permissions
  - Added StateError exception to exceptions.py hierarchy
  - Phase 1 complete: ABC foundation created
  - Phase 2-6 pending: Manager inheritance migration
  - 19 tests passing, 14 skipped (pending phases)

### Changed
- Migrate SessionTracker to inherit from StateManager ABC (#224)
  - SessionTracker now inherits from StateManager[str] (str for markdown content)
  - Implements abstract methods: load_state(), save_state(), cleanup_state()
  - Uses inherited helpers: _validate_state_path(), _atomic_write(), _get_file_lock(), _audit_operation()
  - Maintains full backward compatibility with existing log() method
  - Phase 5 of StateManager migration: SessionTracker complete
- Migrate CheckpointManager to inherit from StateManager ABC (#223)
  - CheckpointManager now inherits from StateManager[Dict[str, Any]]
  - Implements abstract methods: load_state(), save_state(), cleanup_state()
  - Uses inherited helpers: _validate_state_path(), _atomic_write(), _get_file_lock(), _audit_operation()
  - CheckpointError is now an alias for StateError (backward compatible)
  - Maintains full backward compatibility with existing create_checkpoint(), load_checkpoint(), etc. methods
  - Reduces code duplication and ensures consistent state management patterns
  - Phase 4 of StateManager migration: CheckpointManager complete
- Migrate UserStateManager to inherit from StateManager ABC (#222)
  - UserStateManager now inherits from StateManager[Dict[str, Any]]
  - Implements abstract methods: load_state(), save_state(), cleanup_state()
  - Uses inherited helpers: _validate_state_path(), _atomic_write(), _get_file_lock(), _audit_operation()
  - UserStateError is now an alias for StateError (backward compatible)
  - Reduces code duplication and ensures consistent state management patterns
  - Phase 3 of StateManager migration: UserStateManager complete
- Migrate BatchStateManager to inherit from StateManager ABC (#221)
  - BatchStateManager now inherits from StateManager[BatchState]
  - Implements abstract methods: load_state(), save_state(), cleanup_state()
  - Uses inherited helpers: _validate_state_path(), _atomic_write(), _get_file_lock(), _audit_operation()
  - Full backward compatibility maintained via delegation to batch-specific methods
  - Reduces code duplication and ensures consistent state management patterns
  - Phase 2 of StateManager migration: BatchStateManager complete
- Consolidate exception hierarchy: All state managers now use StateError (#225)
  - BatchStateError is now an alias for StateError (backward compatible)
  - brownfield_retrofit.py now imports StateError from centralized exceptions.py
  - Exception hierarchy: AutonomousDevError > StateError (all state-related errors)
  - Ensures consistent exception handling across all state managers
  - Phase 6 of StateManager migration: Exception consolidation complete

### Deprecated
- `/auto-implement` command - Use `/implement` instead (full pipeline is default) (#203)
- `/batch-implement` command - Use `/implement --batch`, `--issues`, or `--resume` (#203)
- Old `/implement` behavior - Use `/implement --quick` for implementer-only mode (#203)
- Deprecation shims redirect to new command with notice, planned removal in v4.0.0

### Removed
- **BREAKING**: Remove deprecated context clearing functions (#218)
  - Removed `should_clear_context()` function
  - Removed `pause_batch_for_clear()` function
  - Removed `get_clear_notification_message()` function
  - Removed `@deprecated` decorator (no longer needed)
  - Removed `CONTEXT_THRESHOLD` constant (150K threshold no longer applicable)
  - Rationale: Claude Code handles context automatically with 200K token budget
  - Migration: Remove any calls to these functions (deprecated since v3.34.0)

### Fixed
- Fix 3 critical test failures blocking CI/CD (#229)
  - Fixed missing `import os` in genai_prompts.py preventing module import
  - Fixed unterminated f-string in test_documentation_consistency.py causing syntax error
  - Fixed incorrect path reference (scripts→hooks) in test_claude_alignment.py
  - All tests now pass in CI/CD pipeline
- Batch worktree CWD change fix
  - `create_batch_worktree()` now automatically changes current working directory to worktree after creation
  - Ensures all subsequent operations (file writes, edits, shell commands) execute within worktree context
  - Returns `original_cwd` in result dictionary for restoration if needed
  - Side effects documented in function docstring and implement.md command documentation
  - Eliminates manual CWD management in batch processing workflows
- Resolve invalid escape sequence warnings in Python 3.12+ (#216)
  - Fixed SyntaxWarning in docstring examples by double-escaping regex patterns
  - Updated files: code_path_analyzer.py, success_criteria_validator.py
  - Applied fixes to both .claude/lib and plugins/autonomous-dev/lib
  - Added 32 regression tests to prevent future reintroduction

### Changed
- Centralize GitHub API exceptions into exceptions.py (#219)
  - Created exceptions.py with AutonomousDevError base and 3-level hierarchy
  - Moved GitHubAPIError, IssueNotFoundError, IssueAlreadyClosedError to central module
  - Updated github_issue_closer.py, github_issue_fetcher.py, batch_issue_closer.py imports
  - Reduces duplicate exception definitions
- Consolidate 3 validate_path() implementations into single source of truth (#217)
  - Unified 3 duplicate implementations into security_utils.validate_path():
    - validation.validate_session_path() now delegates to security_utils
    - feature_flags.validate_path() now delegates to security_utils
    - worktree_conflict_integration.validate_path() now delegates to security_utils
  - Security improvements: 4-layer validation (string-level checks, symlink detection, path resolution, whitelist validation)
  - Reduces code duplication (~150 lines)
  - Ensures consistent path validation across codebase
  - Applied to both .claude/lib and plugins/autonomous-dev/lib
  - Added 23 regression tests for path validation consolidation
- Audit and consolidate validation hooks (#215)
  - Unified 12 documentation validators into unified_doc_validator.py dispatcher:
    - Consolidated: validate_project_alignment, validate_claude_alignment, validate_documentation_alignment, validate_docs_consistency, validate_readme_accuracy, validate_readme_sync, validate_readme_with_genai, validate_command_file_ops, validate_commands, validate_hooks_documented, validate_command_frontmatter_flags, validate_manifest_doc_alignment
    - Documented environment variable defaults: VALIDATE_PROJECT_ALIGNMENT=true, VALIDATE_CLAUDE_ALIGNMENT=true, VALIDATE_DOC_ALIGNMENT=true, etc.
  - Unified 2 manifest validators into unified_manifest_sync.py dispatcher:
    - Consolidated: validate_install_manifest, validate_settings_hooks
    - Documented environment variable defaults: VALIDATE_MANIFEST=true, VALIDATE_SETTINGS=true, AUTO_UPDATE_MANIFEST=true
  - Updated HOOK-REGISTRY.md to mark validate_project_alignment and validate_claude_alignment as deprecated (consolidated)
  - Updated global_settings_template.json with documented PreCommit hooks section referencing unified validators
  - Improved maintainability: Single dispatcher pattern for validation hooks with clear env var control

### Added
- Document evaluation decision for setup-wizard.md split (#214)
  - Created docs/evaluations/ directory with evaluation documentation
  - Issue #214: Evaluated whether to split setup-wizard.md (1,145 lines) into multiple agents
  - Decision: KEEP UNIFIED with hybrid optimizations (extract reusable libraries)
  - Documented sequential phase dependencies and user experience impact
  - Added evaluation tests to validate assumptions and decision rationale
  - Created docs/evaluations/README.md as index of evaluation documents
  - Established pattern for future architectural evaluations
- Create HOOK-REGISTRY.md with activation status (#209)
  - Comprehensive registry of all 66 hooks with activation status
  - Documents trigger points, environment variables, and purposes
  - Provides quick reference for hook lifecycle integration points
  - Added cross-references to HOOKS.md, SANDBOXING.md, GIT-AUTOMATION.md
  - Added 34 tests for hook registry validation

### Changed
- Consolidate alignment commands into single /align command (#210)
  - Removed legacy commands: `/align-project`, `/align-project-retrofit`, `/align-claude`
  - Consolidated into `/align` with three modes: `project`, `retrofit`, `claude`
  - Updated BROWNFIELD-ADOPTION.md to use `/align --retrofit`
  - Updated WORKFLOWS.md to use `/align` and `/align --retrofit`
  - Added 35 tests for command consolidation validation
- Consolidate ARCHITECTURE.md into ARCHITECTURE-OVERVIEW.md (#208)
  - Archived ARCHITECTURE.md to docs/archived/ with deprecation notice
  - Updated 10+ file references to point to ARCHITECTURE-OVERVIEW.md
  - Added 21 tests for consolidation validation
  - Ensures single source of truth for architecture documentation
- Archive disabled hooks with deprecation docs (#211)
  - Consolidated auto_approve_tool.py and mcp_security_enforcer.py into unified_pre_tool.py
  - Created plugins/autonomous-dev/hooks/archived/README.md with migration guide
  - Updated docs/HOOKS.md with consolidated hook consolidation section
  - Updated docs/SANDBOXING.md with historical note and consolidated architecture explanation
  - Updated docs/TOOL-AUTO-APPROVAL.md with deprecation notice (Layer 4 of unified_pre_tool.py)
  - Updated docs/MCP-SECURITY.md with deprecation notice (Layer 2 of unified_pre_tool.py)
  - Updated docs/HOOK-REGISTRY.md to mark archived hooks as deprecated
  - No functionality changes - all features preserved in unified_pre_tool.py
- Resolve duplicate auto_git_workflow.py (#212)
  - Archived duplicate auto_git_workflow.py hook file
  - Created backward compatibility shim at .claude/hooks/auto_git_workflow.py (56 lines)
  - Shim redirects to unified_git_automation.py for single source of truth
  - Updated docs/GIT-AUTOMATION.md with deprecation notice and migration guidance
  - Updated docs/HOOKS.md with archival context
  - Updated docs/ARCHITECTURE-OVERVIEW.md to document shim and unified implementation
  - Updated plugins/autonomous-dev/hooks/archived/README.md with auto_git_workflow.py archival details
  - All git automation functionality preserved with unified consolidation
- Standardize command YAML frontmatter (#213)
  - Created COMMAND-FRONTMATTER-SCHEMA.md with complete field definitions and examples
  - Updated all 21 command files to use kebab-case field names (argument-hint, allowed-tools)
  - Deprecated `tools:` field in favor of `allowed-tools:` (security-enforced)
  - Added validation hook: validate_command_frontmatter_flags.py
  - Added 28 tests for frontmatter standardization validation
  - Ensures consistent autocomplete metadata and security whitelisting

## [3.46.0] - 2026-01-09
### Changed
- Update component counts across all documentation (#207)
  - Commands: 9 → 24 (consolidated /implement variations, added /worktree and others)
  - Hooks: 64 → 67 (added pre-commit hook variations)
  - Libraries: 69 → 145 (expanded automation, validation, infrastructure libraries)
  - Updated CLAUDE.md Component Versions table
  - Updated docs/ARCHITECTURE-OVERVIEW.md counts
  - Updated docs/DOCUMENTATION_INDEX.md counts
- Simplify version tracking: Single source of truth via VERSION file (#206)
  - CLAUDE.md now references `plugins/autonomous-dev/VERSION` instead of hardcoded version
  - Removed Version column from Component Versions table
  - Removed version annotations from pipeline step descriptions
  - Added `_read_version_file()` and `_check_no_hardcoded_versions()` validation methods

### Fixed
- Fix doc-master auto-apply (#204)
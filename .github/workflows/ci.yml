name: CI

# Continuous Integration - runs on every push and PR
# Ensures code quality and catches regressions before merge

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  # Stage 1: Fast smoke tests (fail fast)
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pyyaml

      - name: Validate test categorization
        run: |
          echo "Validating test categorization..."
          python scripts/validate_test_categorization.py --report

      - name: Run smoke tests
        run: |
          echo "Running smoke tests (fast sanity check)..."
          python -m pytest tests/regression/smoke/ -v --tb=short -o "addopts="

  # Stage 2: Full test suite (only if smoke passes)
  test:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: smoke
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pyyaml

      - name: Run unit tests
        run: |
          echo "Running unit tests..."
          python -m pytest tests/unit/ -v --tb=short -o "addopts=" --ignore=tests/archived/

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          python -m pytest tests/integration/ -v --tb=short -o "addopts=" --ignore=tests/archived/

      - name: Run regression tests
        run: |
          echo "Running regression tests..."
          python -m pytest tests/regression/ -v --tb=short -o "addopts=" --ignore=tests/archived/

  # Stage 3: Summary
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [smoke, test]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.smoke.result }}" == "failure" ]; then
            echo "Smoke tests failed - blocking merge"
            exit 1
          fi
          if [ "${{ needs.test.result }}" == "failure" ]; then
            echo "Test suite failed - blocking merge"
            exit 1
          fi
          echo "All CI checks passed!"

name: Issue Automation Workflow

# Trigger on issue events
"on":
  issues:
    types:
      - opened
      - edited
      - labeled
      - reopened
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight for stale issue detection

jobs:
  # Auto-triage new issues
  triage:
    name: Auto-Triage Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Analyze issue and apply labels
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();

            const labels = [];

            // Priority detection
            if (title.includes('critical') || body.includes('production down')) {
              labels.push('priority:high');
            } else if (title.includes('enhancement') || title.includes('nice to have')) {
              labels.push('priority:low');
            } else {
              labels.push('priority:medium');
            }

            // Type detection
            if (title.includes('bug') || body.includes('error')) {
              labels.push('bug');
            } else if (title.includes('feature') || title.includes('enhancement')) {
              labels.push('enhancement');
            } else if (title.includes('docs')) {
              labels.push('documentation');
            }

            // Status
            labels.push('needs-triage');

            // Apply labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });

  # Auto-label by content
  content-labeling:
    name: Label by Content
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'edited')
    steps:
      - uses: github/issue-labeler@v3.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/issue-labeler.yml

  # Auto-assign issues
  assign:
    name: Auto-Assign Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    steps:
      - name: Assign by expertise
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            let assignee = null;

            // Expertise-based assignment
            if (labels.includes('backend') || labels.includes('python')) {
              assignee = 'alice';
            } else if (labels.includes('frontend') || labels.includes('javascript')) {
              assignee = 'bob';
            } else if (labels.includes('devops')) {
              assignee = 'charlie';
            } else if (labels.includes('documentation')) {
              assignee = 'diana';
            }

            if (assignee) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: [assignee]
              });
            }

  # Round-robin assignment for general issues
  round-robin-assign:
    name: Round-Robin Assignment
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - uses: pozil/auto-assign-issue@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          assignees: alice,bob,charlie,diana
          numOfAssignee: 1

  # Stale issue detection
  stale:
    name: Detect Stale Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/stale@v8
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: >
            This issue has been automatically marked as stale because it has not had
            recent activity. It will be closed if no further activity occurs. Thank you
            for your contributions.
          close-issue-message: >
            This issue has been automatically closed due to inactivity. If you believe
            this is still relevant, please reopen or create a new issue.
          days-before-stale: 60
          days-before-close: 7
          exempt-issue-labels: 'pinned,security,roadmap'
          stale-issue-label: 'stale'

  # Link related issues
  link-issues:
    name: Link Related Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Detect and link duplicates
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';

            // Extract issue references (#123)
            const matches = body.match(/#(\d+)/g);

            if (matches) {
              const comment = `This issue is linked to: ${matches.join(', ')}`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });
            }
